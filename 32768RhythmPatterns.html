import React, { useState, useMemo } from 'react';
import { Search, Music, ArrowRight, Download, FileText } from 'lucide-react';

const RhythmLibrary = () => {
  const [patternId, setPatternId] = useState(0);
  const [inputRhythm, setInputRhythm] = useState('X---X---X---X---');
  const [searchDistance, setSearchDistance] = useState(2);
  const [showSimilar, setShowSimilar] = useState(false);
  const [exportRange, setExportRange] = useState({ start: 0, end: 100 });
  const [showExport, setShowExport] = useState(false);

  // Convert pattern ID to rhythm string
  const getPatternString = (id) => {
    if (id < 0 || id > 32767) return 'X---------------';
    
    // First step is always X
    let pattern = 'X';
    
    // Convert id to 15-bit binary for remaining steps
    const binary = id.toString(2).padStart(15, '0');
    
    // 1 = hit (X), 0 = sustain (-)
    for (let i = 0; i < 15; i++) {
      pattern += binary[i] === '1' ? 'X' : '-';
    }
    
    return pattern;
  };

  // Format pattern with spacing for readability
  const formatPattern = (pattern) => {
    return `${pattern.slice(0, 4)} ${pattern.slice(4, 8)} ${pattern.slice(8, 12)} ${pattern.slice(12, 16)}`;
  };

  // Convert rhythm string to pattern ID
  const rhythmToId = (rhythm) => {
    const clean = rhythm.replace(/\s/g, '');
    if (clean.length !== 16) return null;
    if (clean[0] !== 'X') return null;
    
    // Convert remaining 15 steps to binary
    let binary = '';
    for (let i = 1; i < 16; i++) {
      binary += (clean[i] === 'X') ? '1' : '0';
    }
    
    return parseInt(binary, 2);
  };

  // Calculate note duration (how many steps until next hit or end)
  const getNoteDurations = (pattern) => {
    const durations = [];
    let currentDuration = 1;
    
    for (let i = 1; i < pattern.length; i++) {
      if (pattern[i] === 'X') {
        durations.push(currentDuration);
        currentDuration = 1;
      } else {
        currentDuration++;
      }
    }
    durations.push(currentDuration);
    
    return durations;
  };

  // Get color based on note duration
  const getNoteColor = (duration) => {
    if (duration >= 4) return { bg: 'bg-red-500', shadow: 'shadow-red-500/50', label: 'Quarter' };
    if (duration >= 2) return { bg: 'bg-blue-500', shadow: 'shadow-blue-500/50', label: 'Eighth' };
    return { bg: 'bg-yellow-400', shadow: 'shadow-yellow-400/50', label: 'Sixteenth' };
  };

  // Find similar patterns using Hamming distance
  const findSimilarPatterns = (targetId, maxDistance, limit = 15) => {
    const matches = [];
    
    for (let i = 0; i < 32768 && matches.length < limit; i++) {
      if (i === targetId) continue;
      
      // XOR to find differences, count set bits
      const diff = (targetId ^ i).toString(2).split('1').length - 1;
      
      if (diff <= maxDistance) {
        matches.push({
          id: i,
          difference: diff
        });
      }
    }
    
    return matches.sort((a, b) => a.difference - b.difference);
  };

  // Generate all patterns in range
  const generatePatternsInRange = (start, end) => {
    const patterns = [];
    for (let i = start; i <= Math.min(end, 32767); i++) {
      patterns.push({
        id: i,
        pattern: getPatternString(i),
        formatted: formatPattern(getPatternString(i))
      });
    }
    return patterns;
  };

  // Export patterns as text
  const exportPatterns = (start, end) => {
    const patterns = generatePatternsInRange(start, end);
    let text = `# 32,768 Rhythm Pattern Library\n`;
    text += `# Format: ID: Pattern (X = hit, - = sustain)\n`;
    text += `# Range: ID ${start} - ${end}\n\n`;
    
    patterns.forEach(p => {
      text += `${p.id}: ${p.formatted}\n`;
    });
    
    // Create download
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rhythm_patterns_${start}_${end}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // Export all patterns (in chunks to avoid memory issues)
  const exportAllPatterns = () => {
    let text = `# 32,768 Rhythm Pattern Library\n`;
    text += `# Format: ID: Pattern (X = hit, - = sustain)\n`;
    text += `# Complete library: ID 0 - 32767\n\n`;
    
    for (let i = 0; i < 32768; i++) {
      const pattern = getPatternString(i);
      const formatted = formatPattern(pattern);
      text += `${i}: ${formatted}\n`;
      
      // Add section headers every 1000 patterns
      if ((i + 1) % 1000 === 0 && i < 32767) {
        text += `\n## ID ${i + 1} - ${Math.min(i + 1000, 32767)}\n`;
      }
    }
    
    // Create download
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'all_32768_rhythm_patterns.txt';
    a.click();
    URL.revokeObjectURL(url);
  };

  const similarPatterns = useMemo(() => {
    if (!showSimilar) return [];
    return findSimilarPatterns(patternId, searchDistance, 15);
  }, [patternId, searchDistance, showSimilar]);

  const handleInputMatch = () => {
    const id = rhythmToId(inputRhythm);
    if (id !== null) {
      setPatternId(id);
      setShowSimilar(false);
    }
  };

  const handleRandomPattern = () => {
    setPatternId(Math.floor(Math.random() * 32768));
    setShowSimilar(false);
  };

  const currentPattern = getPatternString(patternId);
  const durations = getNoteDurations(currentPattern);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white p-8">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="text-center mb-12">
          <h1 className="text-5xl font-bold mb-4 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
            32,768 Rhythm Patterns
          </h1>
          <p className="text-slate-300 text-lg">
            Every possible 16-step rhythm pattern • 2¹⁵ = 32,768 combinations
          </p>
          <p className="text-slate-400 text-sm mt-2">
            First step always starts with a hit (X) • No rests allowed
          </p>
        </div>

        {/* Main Pattern Display */}
        <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-8 mb-8 border border-purple-500/20">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-semibold">Pattern #{patternId}</h2>
            <div className="flex gap-2">
              <button
                onClick={handleRandomPattern}
                className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors flex items-center gap-2"
              >
                <Music size={18} />
                Random
              </button>
              <button
                onClick={() => setShowExport(!showExport)}
                className="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors flex items-center gap-2"
              >
                <Download size={18} />
                Export
              </button>
            </div>
          </div>

          {/* Pattern ID Input */}
          <div className="mb-8">
            <label className="block text-sm text-slate-400 mb-2">Pattern ID (0-32767)</label>
            <input
              type="number"
              min="0"
              max="32767"
              value={patternId}
              onChange={(e) => {
                const val = parseInt(e.target.value) || 0;
                setPatternId(Math.max(0, Math.min(32767, val)));
                setShowSimilar(false);
              }}
              className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white text-lg focus:border-purple-500 focus:outline-none"
            />
          </div>

          {/* Pattern Notation */}
          <div className="space-y-6">
            <div>
              <h3 className="text-sm text-slate-400 mb-3 font-semibold">RHYTHM PATTERN (X = hit, - = sustain)</h3>
              <div className="font-mono text-4xl bg-slate-900/50 p-6 rounded-lg tracking-wider">
                {formatPattern(currentPattern).split('').map((char, i) => (
                  <span
                    key={i}
                    className={`
                      ${char === 'X' ? 'text-green-400 font-bold' : ''}
                      ${char === '-' ? 'text-purple-400' : ''}
                      ${char === ' ' ? 'ml-2' : ''}
                    `}
                  >
                    {char}
                  </span>
                ))}
              </div>
            </div>

            {/* Visual Grid - Horizontal */}
            <div>
              <h3 className="text-sm text-slate-400 mb-3 font-semibold">
                VISUAL GRID (Red = Quarter, Blue = Eighth, Yellow = Sixteenth)
              </h3>
              <div className="bg-slate-900/50 p-6 rounded-lg">
                <div className="flex gap-1 mb-4">
                  {currentPattern.split('').map((char, i) => {
                    let noteIndex = 0;
                    for (let j = 0; j < i; j++) {
                      if (currentPattern[j] === 'X' && j !== 0) noteIndex++;
                    }
                    
                    const isHit = char === 'X';
                    const duration = durations[noteIndex];
                    const color = getNoteColor(duration);
                    
                    return (
                      <div key={i} className="flex flex-col items-center">
                        <div
                          className={`w-12 h-20 rounded transition-all ${
                            isHit 
                              ? `${color.bg} shadow-lg ${color.shadow} border-2 border-white` 
                              : `${color.bg} opacity-70`
                          }`}
                        />
                        <div className="text-xs text-slate-500 mt-1">{i + 1}</div>
                      </div>
                    );
                  })}
                </div>
                
                {/* Beat Markers */}
                <div className="grid grid-cols-4 gap-4 mt-4 text-sm text-slate-400 text-center font-semibold">
                  <div>Beat 1</div>
                  <div>Beat 2</div>
                  <div>Beat 3</div>
                  <div>Beat 4</div>
                </div>

                {/* Color Legend */}
                <div className="flex gap-6 mt-6 justify-center text-sm">
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 bg-red-500 rounded"></div>
                    <span className="text-slate-300">Quarter Note (4+ steps)</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 bg-blue-500 rounded"></div>
                    <span className="text-slate-300">Eighth Note (2-3 steps)</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-4 h-4 bg-yellow-400 rounded"></div>
                    <span className="text-slate-300">Sixteenth Note (1 step)</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Note Analysis */}
            <div>
              <h3 className="text-sm text-slate-400 mb-3 font-semibold">NOTE ANALYSIS</h3>
              <div className="bg-slate-900/50 p-4 rounded-lg">
                <div className="flex flex-wrap gap-3">
                  {currentPattern.split('').map((char, i) => {
                    if (char !== 'X') return null;
                    
                    let noteIndex = currentPattern.slice(0, i + 1).split('X').length - 1;
                    const duration = durations[noteIndex];
                    const color = getNoteColor(duration);
                    
                    return (
                      <div key={i} className="flex items-center gap-2 bg-slate-800 px-3 py-2 rounded">
                        <div className={`w-3 h-3 rounded-full ${color.bg}`}></div>
                        <span className="text-slate-300">
                          Step {i + 1}: {color.label} ({duration} step{duration !== 1 ? 's' : ''})
                        </span>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Export Section */}
        {showExport && (
          <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-8 mb-8 border border-green-500/20">
            <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2">
              <FileText size={24} />
              Export Patterns
            </h2>

            <div className="space-y-6">
              {/* Export All */}
              <div className="bg-slate-900/50 p-6 rounded-lg border border-slate-700">
                <h3 className="text-lg font-semibold mb-3">Export All 32,768 Patterns</h3>
                <p className="text-slate-400 text-sm mb-4">
                  Download a complete text file containing all rhythm patterns
                </p>
                <button
                  onClick={exportAllPatterns}
                  className="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg transition-colors flex items-center gap-2"
                >
                  <Download size={20} />
                  Download All Patterns (32,768)
                </button>
              </div>

              {/* Export Range */}
              <div className="bg-slate-900/50 p-6 rounded-lg border border-slate-700">
                <h3 className="text-lg font-semibold mb-3">Export Pattern Range</h3>
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Start ID</label>
                    <input
                      type="number"
                      min="0"
                      max="32767"
                      value={exportRange.start}
                      onChange={(e) => setExportRange({...exportRange, start: parseInt(e.target.value) || 0})}
                      className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-green-500 focus:outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">End ID</label>
                    <input
                      type="number"
                      min="0"
                      max="32767"
                      value={exportRange.end}
                      onChange={(e) => setExportRange({...exportRange, end: parseInt(e.target.value) || 0})}
                      className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-green-500 focus:outline-none"
                    />
                  </div>
                </div>
                <button
                  onClick={() => exportPatterns(exportRange.start, exportRange.end)}
                  className="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg transition-colors flex items-center gap-2"
                >
                  <Download size={20} />
                  Download Range ({exportRange.end - exportRange.start + 1} patterns)
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Pattern Matching */}
        <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-8 mb-8 border border-purple-500/20">
          <h2 className="text-2xl font-semibold mb-6 flex items-center gap-2">
            <Search size={24} />
            Pattern Matching
          </h2>

          <div className="space-y-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">
                Enter your rhythm (16 characters: X = hit, - = sustain, first step must be X)
              </label>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={inputRhythm}
                  onChange={(e) => setInputRhythm(e.target.value)}
                  placeholder="X---X---X---X---"
                  className="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 font-mono text-lg focus:border-purple-500 focus:outline-none"
                />
                <button
                  onClick={handleInputMatch}
                  className="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg transition-colors flex items-center gap-2"
                >
                  <ArrowRight size={20} />
                  Find
                </button>
              </div>
            </div>

            <div className="text-sm text-slate-400">
              Examples: "X---X---X---X---" (ID 0, quarter notes) • "X-X-X-X-X-X-X-X-" (ID 21845, eighth notes) • "XXXXXXXXXXXXXXXX" (ID 32767, sixteenth notes)
            </div>
          </div>
        </div>

        {/* First 10 Patterns Reference */}
        <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-8 mb-8 border border-purple-500/20">
          <h2 className="text-2xl font-semibold mb-6">First 10 Base Patterns</h2>
          <div className="space-y-2">
            {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9].map(id => (
              <div
                key={id}
                onClick={() => {
                  setPatternId(id);
                  setShowSimilar(false);
                  window.scrollTo({ top: 0, behavior: 'smooth' });
                }}
                className="bg-slate-700/50 hover:bg-slate-700 p-4 rounded-lg cursor-pointer transition-colors border border-slate-600/50 hover:border-purple-500/50 flex items-center justify-between"
              >
                <span className="font-semibold w-20">ID {id}</span>
                <span className="font-mono text-lg flex-1">{formatPattern(getPatternString(id))}</span>
              </div>
            ))}
          </div>
        </div>

        {/* Similar Patterns */}
        <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-8 border border-purple-500/20">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-semibold">Find Similar Patterns</h2>
            <button
              onClick={() => setShowSimilar(!showSimilar)}
              className={`px-4 py-2 rounded-lg transition-colors ${
                showSimilar 
                  ? 'bg-purple-600 hover:bg-purple-700' 
                  : 'bg-slate-700 hover:bg-slate-600'
              }`}
            >
              {showSimilar ? 'Hide' : 'Show'} Similar
            </button>
          </div>

          {showSimilar && (
            <>
              <div className="mb-6">
                <label className="block text-sm text-slate-400 mb-2">
                  Max Hamming Distance (differences): {searchDistance}
                </label>
                <input
                  type="range"
                  min="1"
                  max="8"
                  value={searchDistance}
                  onChange={(e) => setSearchDistance(parseInt(e.target.value))}
                  className="w-full"
                />
              </div>

              <div className="space-y-3 max-h-96 overflow-y-auto">
                {similarPatterns.map((pattern) => (
                  <div
                    key={pattern.id}
                    onClick={() => {
                      setPatternId(pattern.id);
                      setShowSimilar(false);
                      window.scrollTo({ top: 0, behavior: 'smooth' });
                    }}
                    className="bg-slate-700/50 hover:bg-slate-700 p-4 rounded-lg cursor-pointer transition-colors border border-slate-600/50 hover:border-purple-500/50"
                  >
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-semibold">Pattern #{pattern.id}</span>
                      <span className="text-xs bg-purple-600/30 px-2 py-1 rounded">
                        {pattern.difference} step{pattern.difference !== 1 ? 's' : ''} different
                      </span>
                    </div>
                    <div className="font-mono text-sm text-slate-300">
                      {formatPattern(getPatternString(pattern.id))}
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>

        {/* Info Footer */}
        <div className="text-center text-slate-500 text-sm mt-8">
          Based on 32,768 rhythm patterns with no rests • First step always begins with a hit
        </div>
      </div>
    </div>
  );
};

export default RhythmLibrary;